#!/bin/bash

dependencies_=()
if [[ "$(uname)" == "Darwin" ]]; then
# software.aliasname.installer
    dependencies_=(autossh.autossh.brew rcm.rcup.brew cargo.cargo.brew exa.exa.cargo bat.bat.cargo fd.fd.cargo ripgrep.rg.cargo)
else
    dependencies_=(autossh.autossh.atp rcm.rcup.apt cargo.cargo.apt exa.exa.cargo bat.bat.cargo fd-find.fd.cargo ripgrep.rg.cargo)
fi

installer_="apt"
function installer() {
    echo $installer_ $@
    if [[ "$installer_" == "apt" ]]; then
        sudo apt $@
    else
        $installer_ $@
    fi
}

function installer_if() {
    software_name=$1
    command_name=$2
    installer_name=$3
    if [[ "$(command -v ${command_name})" == "" ]]; then
        installer_=${installer_name}
        installer install $software_name
    fi
}

function check_dotfiles() {
    if [[ ! -d $HOME/.dotfiles ]]; then
        git clone https://github.com/caibingcheng/dotfiles.git $HOME/.dotfiles
    fi
}

function install_dependencies() {
    # installer update
    for dependency in ${dependencies_[@]}; do
        params=$(echo $dependency | awk -F'.' '{print $1" "$2" "$3}')
        installer_if $params
    done
}

function install_rcm() {
    if [[ "$(command -v rcup)" != "" ]]; then
        return 0
    fi
    if [[ "$(uname)" == "Linux" ]]; then
        sudo wget -q https://apt.thoughtbot.com/thoughtbot.gpg.key -O /etc/apt/trusted.gpg.d/thoughtbot.gpg
        echo "deb https://apt.thoughtbot.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/thoughtbot.list
        sudo apt-get update
    fi
}

function setup_rc() {
    rcup -t rcm -x LICENSE -x README.md -x setup
    if [[ "$@" != "" ]]; then
        rcup -t $@
    fi
}

function main() {
    install_rcm
    check_dotfiles
    install_dependencies

    target=$@
    SHELL_TYPE=$(echo $SHELL | awk -F'/' '{print $NF}')
    if [[ "$target" == "" ]]; then
        target=$SHELL_TYPE
    fi
    setup_rc $target
}

main $@
