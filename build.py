import toml
import sys

dependencies_source_file = "dependencies.toml" if len(sys.argv) < 2 else sys.argv[1]
dependencies_target_file = "dependencies" if len(sys.argv) < 3 else sys.argv[2]
dependencies = toml.load(dependencies_source_file)


def install_dependencies(section, tools):
    install_list = f"dependencies_{section}=("
    for tool in tools:
        tool_name = tool
        tool_alternative_name = tools[tool]["alt"]
        tool_installer = tools[tool]["installer"]

        tool_name = tool_name if isinstance(tool_name, list) else [tool_name]
        tool_alternative_name = (
            tool_alternative_name
            if isinstance(tool_alternative_name, list)
            else [tool_alternative_name]
        )
        tool_installer = (
            tool_installer if isinstance(tool_installer, list) else [tool_installer]
        )
        tool_installer = [
            installer if installer != "default" else "${binstaller}"
            for installer in tool_installer
        ]

        tool_name_bash_string = ",".join(tool_name)
        tool_alternative_name_bash_string = ",".join(tool_alternative_name)
        tool_installer_bash_string = ",".join(tool_installer)
        install_list += f"{tool_name_bash_string}.{tool_alternative_name_bash_string}.{tool_installer_bash_string} "
    install_list = install_list[:-1]
    install_list += ")\n"
    return install_list


# clear the file
with open(dependencies_target_file, "w") as f:
    f.write("### !!! DO NOT EDIT THIS FILE !!! ###\n\n")
    for section in dependencies:
        f.write(install_dependencies(section, dependencies[section]))
